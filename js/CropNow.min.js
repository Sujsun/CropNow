/**
 * Title: CropNow
 * Author: Sundarasan Natarajan
 * Date: 28/5/2015
 */
!function(t){function i(){var t=document.createElement("canvas");return!(!t.getContext||!t.getContext("2d"))}function e(t){function i(){return t.cropper?r(t):void 0}if(g||function(){throw{name:"BroswerCompatibiltyError",message:"canvas/HTML5 is not supported, try updating your broswer"}}(),t=t||{},t.isNewImage=!0,t.previewImage||(t.previewImage={}),t.resizedRatio={},t.originalSizeCoordinates={},t.canvas||(t.canvas=window.document.createElement("canvas")),!t.file&&!t.image)throw'Pass ["image"] attribute or ["file", "image"] attributes in options';return t.image||function(){throw'Pass "image" attribute in options'}(),t.file&&d(t.file,"change",function(i){a(i,t)}),d(t.image,"load",function(){t.previewImage.src=t.image.src,t.originalSizeImage=n(t.image.src,function(i){s(i,t)})}),l||(l=h()),{getBase64:i}}function o(t){var i={};return t.ratio&&(i.ratio=t.ratio),t.min_width&&(i.min_width=t.min_width),t.min_height&&(i.min_height=t.min_height),t.max_width&&(i.max_width=t.max_width),t.max_height&&(i.max_height=t.max_height),i.update=function(){t.isCropStarted=!0,(t.onCrop||void 0!==t.previewImage.tagName)&&r(t)},new p(t.image,i)}function r(t){if(t.isCropStarted){var i=t.cropper.coordinates;t.originalSizeCoordinates.x=i.x*t.resizedRatio.width,t.originalSizeCoordinates.y=i.y*t.resizedRatio.height,t.originalSizeCoordinates.width=i.width*t.resizedRatio.width,t.originalSizeCoordinates.height=i.height*t.resizedRatio.height;try{t.resize?(t.canvas.width=t.resize.width,t.canvas.height=t.resize.height,t.previewImage.width=t.resize.width,t.previewImage.height=t.resize.height):(t.canvas.width=t.originalSizeCoordinates.width,t.canvas.height=t.originalSizeCoordinates.height,t.previewImage.width=t.originalSizeCoordinates.width,t.previewImage.height=t.originalSizeCoordinates.height),t.canvas.getContext("2d").drawImage(t.originalSizeImage,t.originalSizeCoordinates.x,t.originalSizeCoordinates.y,t.originalSizeCoordinates.width,t.originalSizeCoordinates.height,0,0,t.canvas.width,t.canvas.height),t.base64Cropped=t.canvas.toDataURL(),t.previewImage&&(t.previewImage.src=t.base64Cropped),t.onCrop&&t.onCrop(t.base64Cropped)}catch(e){"SecurityError"===e.name&&(t.canvas=window.document.createElement("canvas"),console.error(new Error({name:"SecurityError",message:"Make sure to serve the image from same domain. You cannot crop/edit image of different domain."}))),console.error(e)}}else delete t.base64Cropped;return t.base64Cropped}function a(t,i){delete i.isCropStarted,c.onloadend=function(t){var e=t.target.result;i.image.src=e},c.readAsDataURL(i.file.files[0])}function s(t,i){i.resizedRatio.width=t.width/i.image.width,i.resizedRatio.height=t.height/i.image.height,i.resize?(i.previewImage.width=i.resize.width,i.previewImage.height=i.resize.height):(i.previewImage.width=t.width,i.previewImage.height=t.height),i.cropper&&i.cropper.unWrapImage(),i.cropper=o(i)}function n(t,i){var e=window.document.createElement("img");return d(e,"load",function(){i&&i({width:e.width,height:e.height})}),e.src=t,e}function h(){var t=window.document.createElement("style");return t.innerHTML=cropperCSSString,window.document.head.appendChild(t),!0}function d(t,i,e){return t&&i&&e&&(window.$?window.$(t).on(i,e):t.addEventListener?t.addEventListener(i,e,!1):t.attachEvent?t.attachEvent("on"+i,e):t["on"+i]=e),t}var p=function(){function t(t,i){return t.currentStyle?t.currentStyle[i]:"function"==typeof window.getComputedStyle?window.getComputedStyle(t,null).getPropertyValue(i):t.style[i]}function i(t){return t=t||window.event,t.target=t.target||t.srcElement,t.relatedTarget=t.relatedTarget||("mouseover"==t.type?t.fromElement:t.toElement),t.target=t.target||t.srcElement,t.stop=function(){t.preventDefault?t.preventDefault():t.returnValue=!1,t.stopPropagation&&t.stopPropagation(),null!=t.cancelBubble&&(t.cancelBubble=!0)},3===t.target.nodeType&&(t.target=t.target.parentNode),t}function e(t){if(null===t||"object"!=typeof t)return t;var i=t.constructor();for(var o in t)i[o]=e(t[o]);return i}var o={container_class:"cropper",width:0,height:0,min_width:0,min_height:0,max_width:0,max_height:0,ratio:{width:0,height:0}};Function.prototype.bind||(Function.prototype.bind=function(t){if("function"!=typeof this)throw new TypeError("Bound function not callable");var i=Array.prototype.slice.call(arguments,1),e=this,o=function(){},r=function(){return e.apply(this instanceof o&&t?this:t,i.concat(Array.prototype.slice.call(arguments)))};return o.prototype=this.prototype,r.prototype=new o,r});var r=function(){return window.addEventListener?function(t,i,e){t.addEventListener(i,e,!1)}:window.attachEvent?function(t,i,e){t.attachEvent("on"+i,e)}:function(t,i,e){t["on"+i]=e}}(),a=function(t,i){this.options=e(o),i=i||{};for(var r in i)this.options[r]=i[r];this.image=t;var a=this.image.getBoundingClientRect();this.width=Math.round(a.right-a.left),this.height=Math.round(a.bottom-a.top),this.coordinates={x:0,y:0,width:0,height:0},this.moving=this.resizing=this.direction=!1,this.handles={},this.overlays={},this.wrapImage(),this.attachEventListeners()};return a.prototype.wrapImage=function(){var i=document.createElement("div");i.className=this.options.container_class;var e=this.image.parentNode,o=this.image.nextSibling;i.appendChild(this.image),this.image.style.padding=this.image.style.margin=this.image.style.border=0,o?e.insertBefore(i,o):e.appendChild(i),this.image.ondragstart=function(){return!1};var r=t(i,"position");"static"==r&&(i.style.position="relative"),i.style.width=this.width+"px",i.style.height=this.height+"px",this.container=i},a.prototype.unWrapImage=function(){this.image.parentNode.parentNode.replaceChild(this.image,this.image.parentNode)},a.prototype.createCropArea=function(){var t=document.createElement("div");t.className=this.options.container_class+"-area",t.style.position="absolute",t.style.cursor="move",t.style.background="url(data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7)",this.createHandles(t),this.createOverlays(t),this.container.appendChild(t),this.crop_area=t},a.prototype.createHandles=function(t){var e=this,o="-3px",a={nw:{left:o,top:o},n:{left:"50%",top:o,marginLeft:o},ne:{right:o,top:o},e:{right:o,top:"50%",marginTop:o},se:{right:o,bottom:o,zIndex:10},s:{left:"50%",bottom:o,marginLeft:o},sw:{left:o,bottom:o},w:{left:o,top:"50%",marginTop:o}};for(var s in a){var n=a[s],h=document.createElement("div");h.className=this.options.container_class+"-area-handle";for(var d in n)h.style[d]=n[d];h.style.position="absolute",h.style.cursor=s+"-resize",h.setAttribute("position",s),t.appendChild(h),r(h,"mousedown",function(t){e.resizing=!0,e.direction=i(t).target.getAttribute("position")}),this.handles[s]=h}},a.prototype.createOverlays=function(){var t={top:{left:0,top:0,right:0,width:"100%"},left:{left:0},right:{right:0},bottom:{left:0,bottom:0,right:0,width:"100%"}};for(position in t){var i=t[position],e=document.createElement("div");e.className=this.options.container_class+"-overlay",e.style.position="absolute";for(var o in i)e.style[o]=i[o];this.container.appendChild(e),this.overlays[position]=e}},a.prototype.attachEventListeners=function(){r(this.container,"mousedown",this.mouseDown.bind(this)),r(document,"mouseup",this.mouseUp.bind(this)),r(document,"mousemove",this.mouseMove.bind(this))},a.prototype.mouseDown=function(t){i(t).stop();var o=i(t).target,r=this.getCursorPosition(t);if(this.crop_area||this.createCropArea(r),this.dragStartCrop=e(this.coordinates),this.dragStart=r,o==this.crop_area)return void(this.moving=!0);if(o.className!=this.options.container_class+"-area-handle"){var a=this.options.width?this.options.width:this.options.min_width?this.options.min_width:0,s=this.options.height?this.options.height:this.options.min_height?this.options.min_height:0;this.coordinates.x=r.x,this.coordinates.y=r.y,this.coordinates.width=a,this.coordinates.height=s,this.dragStartCrop=e(this.coordinates),this.crop(),a&&s||(this.resizing=!0,this.direction="se")}},a.prototype.crop=function(){this.confine(),this.crop_area.style.left=this.coordinates.x+"px",this.crop_area.style.top=this.coordinates.y+"px",this.crop_area.style.width=this.coordinates.width+"px",this.crop_area.style.height=this.coordinates.height+"px",this.overlays.top.style.height=this.overlays.left.style.top=this.overlays.right.style.top=this.coordinates.y+"px",this.overlays.left.style.height=this.overlays.right.style.height=this.coordinates.height+"px",this.overlays.left.style.width=this.coordinates.x+"px",this.overlays.right.style.width=this.width-this.coordinates.x-this.coordinates.width+"px",this.overlays.bottom.style.height=this.height-this.coordinates.y-this.coordinates.height+"px","function"==typeof this.options.update&&this.options.update.call(this,this.coordinates)},a.prototype.confine=function(){var t,i;this.coordinates.x<0&&(this.coordinates.x=0),this.coordinates.y<0&&(this.coordinates.y=0),t=this.coordinates.x+this.coordinates.width>this.width,i=this.coordinates.y+this.coordinates.height>this.height,t&&this.toPrevPosition(),i&&this.toPrevPosition(),!t&&!i&&this.setCurrentPositionAsPrevPosition()},a.prototype.setCurrentPositionAsPrevPosition=function(){this.previousCoordinates.x=this.coordinates.x,this.previousCoordinates.y=this.coordinates.y,this.previousCoordinates.width=this.coordinates.width,this.previousCoordinates.height=this.coordinates.height},a.prototype.toPrevPosition=function(){void 0!==this.previousCoordinates.x&&(this.coordinates.x=this.previousCoordinates.x,this.coordinates.y=this.previousCoordinates.y,this.coordinates.width=this.previousCoordinates.width,this.coordinates.height=this.previousCoordinates.height)},a.prototype.previousCoordinates={},a.prototype.mouseUp=function(){this.resizing=this.moving=this.direction=!1},a.prototype.mouseMove=function(t){return this.resizing?this.resize(t):this.moving?this.move(t):void 0},a.prototype.resize=function(t){function i(){this.direction.match(/w/)?(r=o.x,s-=delta_x,o.x>this.dragStartCrop.x+this.dragStartCrop.width&&(this.direction=this.direction.replace("w","e"),r=this.dragStartCrop.x+this.dragStartCrop.width,this.dragStart.x=this.dragStartCrop.x=r,this.dragStartCrop.width=s=0)):this.direction.match(/e/)&&(s=Math.min(s+delta_x,this.width-r),o.x<this.dragStartCrop.x&&(this.direction=this.direction.replace("e","w"),this.dragStart.x=r,this.dragStartCrop.width=s=0))}function e(t){this.direction.match(/n/)?(t?(n=Math.round(s/t),a=this.dragStartCrop.y+this.dragStartCrop.height-n):(a=o.y,n-=delta_y),o.y>this.dragStartCrop.y+this.dragStartCrop.height&&(this.direction=this.direction.replace("n","s"),a=this.dragStart.y+this.dragStartCrop.height,this.dragStart.y=this.dragStartCrop.y=a,this.dragStartCrop.height=n=0)):this.direction.match(/s/)&&(n=t?Math.round(s/t):Math.min(n+delta_y,this.height-a),o.y<this.dragStartCrop.y&&(this.direction=this.direction.replace("s","n"),this.dragStart.y=a,this.dragStartCrop.height=n=0))}var o=this.getCursorPosition(t),r=this.dragStartCrop.x,a=this.dragStartCrop.y,s=this.dragStartCrop.width,n=this.dragStartCrop.height;if(o.x=Math.max(0,o.x),o.y=Math.max(0,o.y),delta_x=o.x-this.dragStart.x,delta_y=o.y-this.dragStart.y,this.options.ratio.width>0&&this.options.ratio.height>0){var h=this.options.ratio.width/this.options.ratio.height;"n"==this.direction||"s"==this.direction?(e.call(this),s=n*h):"w"==this.direction||"e"==this.direction?(i.call(this),n=s/h):(i.call(this),e.call(this,h))}else i.call(this),e.call(this);this.options.min_width&&(s=Math.max(s,this.options.min_width)),this.options.min_height&&(n=Math.max(n,this.options.min_height)),this.options.max_width&&(s=Math.min(s,this.options.max_width)),this.options.max_height&&(n=Math.min(n,this.options.max_height)),this.coordinates.x=Math.round(r),this.coordinates.y=Math.round(a),this.coordinates.width=Math.round(s),this.coordinates.height=Math.round(n),this.crop()},a.prototype.move=function(t){var i=this.getCursorPosition(t),e=i.x-this.dragStart.x,o=i.y-this.dragStart.y;this.coordinates.x=this.dragStartCrop.x+e,this.coordinates.y=this.dragStartCrop.y+o,this.crop()},a.prototype.getCursorPosition=function(t){var e=this.container.getBoundingClientRect();return t=i(t),{x:Math.round(t.clientX-e.left),y:Math.round(t.clientY-e.top)}},a}(),c=new FileReader,g=i(),l=!1;cropperCSSString=".cropper { position: relative; cursor: crosshair; } .cropper-area-handle { width: 6px; height: 6px; background: yellow; } .cropper-overlay { background: black; opacity: 0.5; filter: alpha(opacity=50); }",t.CropNow=e}(this);